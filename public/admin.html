<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Conecta Web Digital</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* bg-slate-900 */
            color: #f1f5f9; /* text-slate-100 */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #admin-dashboard, #loader {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Loader Inicial -->
    <div id="loader" class="flex flex-col items-center justify-center h-screen">
        <div class="loader"></div>
        <p class="mt-4 text-slate-400">Carregando...</p>
    </div>

    <!-- Dashboard Administrativo -->
    <div id="admin-dashboard" class="w-full h-screen flex flex-col">
        <!-- Cabeçalho do Dashboard -->
        <header class="bg-slate-800/80 backdrop-blur-lg border-b border-slate-700 shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <span class="font-bold text-xl text-white">Dashboard</span>
                    </div>
                    <div>
                        <button id="logout-button"
                                class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main class="flex-1 p-4 sm:p-6 lg:p-8 bg-slate-900 overflow-y-auto">
            <div class="max-w-7xl mx-auto">
                <h1 class="text-2xl font-bold text-white mb-6">Gerenciamento de Perguntas</h1>

                <!-- Seção de Perguntas Pendentes -->
                <div class="mb-12">
                    <h2 class="text-xl font-semibold text-white mb-4 border-b-2 border-amber-500 pb-2">Perguntas Pendentes</h2>
                    <div id="pending-questions" class="space-y-4">
                        <p id="no-pending-questions" class="text-slate-400">Nenhuma pergunta pendente no momento.</p>
                        <!-- Cards de perguntas pendentes serão inseridos aqui -->
                    </div>
                </div>

                <!-- Seção de Perguntas Aprovadas -->
                <div>
                    <h2 class="text-xl font-semibold text-white mb-4 border-b-2 border-green-500 pb-2">Perguntas Aprovadas</h2>
                    <div id="approved-questions" class="space-y-4">
                       <p id="no-approved-questions" class="text-slate-400">Nenhuma pergunta aprovada ainda.</p>
                       <!-- Cards de perguntas aprovadas serão inseridos aqui -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc, updateDoc, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuração do Firebase com suas credenciais
        const firebaseConfig = {
          apiKey: "AIzaSyAlJ1UWCsKPymTE0cOvHP1wveznX8X3j1o",
          authDomain: "conecta-web-digital.firebaseapp.com",
          projectId: "conecta-web-digital",
          storageBucket: "conecta-web-digital.appspot.com",
          messagingSenderId: "341962931462",
          appId: "1:341962931462:web:a4c62fe83a8db5f9bcb287",
          measurementId: "G-ETY22T8XTP"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loader = document.getElementById('loader');
        const adminDashboard = document.getElementById('admin-dashboard');
        const logoutButton = document.getElementById('logout-button');
        const pendingQuestionsContainer = document.getElementById('pending-questions');
        const approvedQuestionsContainer = document.getElementById('approved-questions');
        const noPendingMsg = document.getElementById('no-pending-questions');
        const noApprovedMsg = document.getElementById('no-approved-questions');

        // --- AUTENTICAÇÃO ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loader.style.display = 'none';
                adminDashboard.style.display = 'flex';
                listenForQuestions();
            } else {
                window.location.href = 'login.html';
            }
        });

        logoutButton.addEventListener('click', () => signOut(auth));

        // --- LÓGICA DO FIRESTORE (GERENCIAMENTO DE PERGUNTAS) ---
        const questionsCollectionRef = collection(db, 'questions');
        const pendingQuery = query(questionsCollectionRef, where("status", "==", "pending"), orderBy("createdAt", "desc"));
        const approvedQuery = query(questionsCollectionRef, where("status", "==", "approved"), orderBy("approvedAt", "desc"));

        function listenForQuestions() {
            // Listener para perguntas pendentes com tratamento de erro
            onSnapshot(pendingQuery, 
                (snapshot) => {
                    pendingQuestionsContainer.innerHTML = '';
                    if (snapshot.empty) {
                        pendingQuestionsContainer.appendChild(noPendingMsg);
                        noPendingMsg.style.display = 'block';
                    } else {
                        noPendingMsg.style.display = 'none';
                        snapshot.docs.forEach(doc => {
                            const question = doc.data();
                            const card = createQuestionCard(doc.id, question, 'pending');
                            pendingQuestionsContainer.appendChild(card);
                        });
                    }
                },
                (error) => {
                    console.error("Erro ao buscar perguntas pendentes: ", error);
                    pendingQuestionsContainer.innerHTML = `<p class="text-red-400 p-4 bg-red-900/20 rounded-lg">Ocorreu um erro ao carregar as perguntas. Verifique o console para mais detalhes. <br><strong>Causa provável:</strong> É necessário criar um índice no Firestore. Siga as instruções no console de erros.</p>`;
                }
            );

            // Listener para perguntas aprovadas com tratamento de erro
            onSnapshot(approvedQuery, 
                (snapshot) => {
                    approvedQuestionsContainer.innerHTML = '';
                     if (snapshot.empty) {
                        approvedQuestionsContainer.appendChild(noApprovedMsg);
                        noApprovedMsg.style.display = 'block';
                    } else {
                        noApprovedMsg.style.display = 'none';
                        snapshot.docs.forEach(doc => {
                            const question = doc.data();
                            const card = createQuestionCard(doc.id, question, 'approved');
                            approvedQuestionsContainer.appendChild(card);
                        });
                    }
                },
                (error) => {
                    console.error("Erro ao buscar perguntas aprovadas: ", error);
                    approvedQuestionsContainer.innerHTML = `<p class="text-red-400 p-4 bg-red-900/20 rounded-lg">Ocorreu um erro ao carregar as perguntas aprovadas.</p>`;
                }
            );
        }

        function createQuestionCard(id, data, type) {
            const card = document.createElement('div');
            card.className = 'bg-slate-800 p-4 rounded-lg shadow-md';
            card.dataset.id = id;

            const questionDate = data.createdAt?.toDate().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' }) || 'Data indisponível';

            if (type === 'pending') {
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2 flex-wrap gap-2">
                        <p class="text-slate-200 font-semibold">De: <span class="text-sky-400 font-bold">${data.userName || 'Anônimo'}</span></p>
                        <p class="text-slate-400 text-sm">Recebida em: ${questionDate}</p>
                    </div>
                    <p class="text-slate-100 bg-slate-900/50 p-3 rounded-md mb-4">${data.questionText}</p>
                    <textarea class="answer-text w-full bg-slate-700 border border-slate-600 rounded-lg p-2 text-white placeholder-slate-400 focus:ring-2 focus:ring-sky-500" rows="3" placeholder="Digite a resposta aqui..."></textarea>
                    <div class="flex gap-4 mt-4">
                        <button class="approve-button flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Aprovar e Responder</button>
                        <button class="delete-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Rejeitar</button>
                    </div>
                `;
            } else { // approved
                card.innerHTML = `
                    <div class="mb-2">
                        <p class="text-slate-200 font-semibold">De: <span class="text-sky-400 font-bold">${data.userName || 'Anônimo'}</span></p>
                    </div>
                    <p class="font-bold text-slate-100 mb-2">${data.questionText}</p>
                    <p class="text-sky-300 bg-black/20 p-3 rounded-md">${data.answerText}</p>
                    <div class="flex gap-4 mt-4">
                        <button class="delete-button bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Excluir</button>
                    </div>
                `;
            }
            return card;
        }

        // Delegação de eventos para os botões
        adminDashboard.addEventListener('click', async (e) => {
            const button = e.target;
            const card = button.closest('.bg-slate-800');
            if (!card) return;
            const id = card.dataset.id;

            // Ação de Aprovar
            if (button.classList.contains('approve-button')) {
                const answerText = card.querySelector('.answer-text').value.trim();
                if (!answerText) {
                    alert('Por favor, digite uma resposta antes de aprovar.');
                    return;
                }
                try {
                    const questionRef = doc(db, 'questions', id);
                    await updateDoc(questionRef, {
                        status: 'approved',
                        answerText: answerText,
                        approvedAt: serverTimestamp()
                    });
                } catch (error) {
                    console.error("Erro ao aprovar pergunta:", error);
                }
            }

            // Ação de Deletar/Rejeitar
            if (button.classList.contains('delete-button')) {
                if (confirm('Tem certeza de que deseja excluir esta pergunta? Esta ação não pode ser desfeita.')) {
                    try {
                        await deleteDoc(doc(db, 'questions', id));
                    } catch (error) {
                        console.error("Erro ao excluir pergunta:", error);
                    }
                }
            }
        });

        loader.style.display = 'flex';
    </script>
</body>
</html>
